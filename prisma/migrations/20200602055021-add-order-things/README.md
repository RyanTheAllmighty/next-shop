# Migration `20200602055021-add-order-things`

This migration has been generated by Ryan Dowling at 6/2/2020, 5:50:21 AM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TABLE `shop`.`Order` (
`customerId` int NOT NULL ,`discount` Decimal(65,30) NOT NULL DEFAULT 0 ,`id` int NOT NULL  AUTO_INCREMENT,`notes` varchar(191) NOT NULL  ,`paymentProvider` ENUM('PAYPAL', 'CREDIT_CARD', 'AFTERPAY', 'ZIPPAY', 'LATITUDE_PAY', 'CASH') NOT NULL  ,`paymentReference` varchar(191)   ,`status` ENUM('PAYMENT_PENDING', 'PAYMENT_RECEIVED', 'DISPATCHED', 'COMPLETE', 'RETURN_STARTED', 'RETURN_RECEIVED', 'RETURN_REJECTED', 'RETURN_DISPATCHED', 'RETURNED') NOT NULL DEFAULT 'PAYMENT_PENDING' ,`total` Decimal(65,30) NOT NULL  ,
    PRIMARY KEY (`id`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci

CREATE TABLE `shop`.`OrderItem` (
`id` int NOT NULL  AUTO_INCREMENT,`orderId` int NOT NULL ,`price` Decimal(65,30) NOT NULL  ,`productId` int NOT NULL ,`quantity` int NOT NULL  ,
    PRIMARY KEY (`id`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci

ALTER TABLE `shop`.`Order` ADD FOREIGN KEY (`customerId`) REFERENCES `shop`.`Customer`(`id`) ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE `shop`.`OrderItem` ADD FOREIGN KEY (`productId`) REFERENCES `shop`.`Product`(`id`) ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE `shop`.`OrderItem` ADD FOREIGN KEY (`orderId`) REFERENCES `shop`.`Order`(`id`) ON DELETE CASCADE ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20200602053443-add-customers-and-addresses..20200602055021-add-order-things
--- datamodel.dml
+++ datamodel.dml
@@ -2,9 +2,9 @@
 // learn more about it in the docs: https://pris.ly/d/prisma-schema
 datasource db {
     provider = "mysql"
-    url = "***"
+    url      = env("DATABASE_URL")
 }
 generator client {
     provider = "prisma-client-js"
@@ -16,9 +16,10 @@
     slug        String @unique
     description String
     price       Float
-    categories Category[] @relation(references: [id])
+    categories Category[]  @relation(references: [id])
+    OrderItem  OrderItem[]
 }
 model Category {
     id          Int    @id @default(autoincrement())
@@ -36,8 +37,9 @@
     email           String
     newsletterOptIn Boolean @default(false)
     addresses Address[]
+    Order     Order[]
 }
 model Address {
     id         Int     @id @default(autoincrement())
@@ -61,4 +63,54 @@
     WA
     TAS
     QLD
 }
+
+model Order {
+    id               Int             @id @default(autoincrement())
+    total            Float
+    discount         Float           @default(0) // discount percent applied to the order (may want to move to a coupon)
+    status           OrderStatus     @default(PAYMENT_PENDING)
+    paymentReference String? // Reference number from the payment provider
+    paymentProvider  PaymentProvider
+    notes            String
+
+    items OrderItem[]
+
+    customer   Customer @relation(fields: [customerId], references: [id])
+    customerId Int
+}
+
+enum OrderStatus {
+    PAYMENT_PENDING
+    PAYMENT_RECEIVED
+    DISPATCHED
+    COMPLETE
+
+    // we may want this to be in a separate field to track returns
+    RETURN_STARTED
+    RETURN_RECEIVED
+    RETURN_REJECTED
+    RETURN_DISPATCHED
+    RETURNED
+}
+
+enum PaymentProvider {
+    PAYPAL
+    CREDIT_CARD
+    AFTERPAY
+    ZIPPAY
+    LATITUDE_PAY
+    CASH
+}
+
+model OrderItem {
+    id       Int   @id @default(autoincrement())
+    price    Float
+    quantity Int
+
+    product   Product @relation(fields: [productId], references: [id])
+    productId Int
+
+    order   Order @relation(fields: [orderId], references: [id])
+    orderId Int
+}
```


